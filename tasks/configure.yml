---
- name: Create redis data directory
  file:
    path: "{{ redis_data_dir }}/{{ redis_port }}"
    recurse: yes
    state: directory
    owner: redis
    group: redis

- name: Create redis configuration
  template:
    src: redis.conf.j2
    dest: /etc/redis/{{ redis_port }}.conf
    owner: redis
    group: redis
  register: configuration_status
  notify:
    - restart redis

- name: Set redis_notify_items facts
  set_fact:
    redis_notify_items: "{{ redis_notify_items|default([]) | union([dict(changed=configuration_status.changed,port=redis_port)]) }}"

- name: Startup redis init script for upstart
  template:
    src: redis.init.j2
    dest: /etc/init.d/redis_{{ redis_port }}
    mode: 0755
  when: ansible_service_mgr in ['upstart','sysvinit']

- name: Startup redis service for systemd
  template:
    src: redis.service.j2
    dest: /lib/systemd/system/redis_{{ redis_port }}.service
  when: ansible_service_mgr == 'systemd'
  notify:
    - daemon-reload

- name: Ensure redis instance state
  service:
    name: redis_{{ redis_port }}
    enabled: true
    state: started
